# XbrlParser リポジトリ仕様書

## 目的
- EDINETのXBRL（ZIP）を解析し、企業別のPL/BS/CFをCSV化し、PPT/PDFレポートを自動生成する。
- 企業固有のXBRL差異は「マッピング設定」に集約し、汎用ロジックを簡潔に保つ。

---

## 全体アーキテクチャ
1. XBRL解析（ZIP → facts DataFrame）
2. PL/BS/CFの正規化（canonical化）と抽出
3. 可視化用データ（trend/snapshot）生成
4. スライド生成（PPT/PDF）

---

## 主要ファイル

### 1) `xbrl_parser.py`
- EDINET XBRL ZIPからインスタンスを抽出して解析。
- 出力は「facts形式」DataFrame（1行=1事実）。
- 主要列
  - `Tag`, `Element`, `Label`, `Value`
  - `ContextID`, `Consolidated`
  - `Standard`（IFRS/USGAAP/JGAAP推定）
  - `period_type`, `period_start`, `period_end`
  - `numeric_value`, `currency`, `dimensions`, `is_text_block`
- 期間正規化、連結/単独判定をここで実施。

### 2) `financial_analyzer.py`
- factsを正規化し、PL/BS/CFの「canonical」テーブルを構築する中核。
- `ColumnDefinitionConfig` からマッピング設定を読み込み、個社対応を実現。
- 主要API
  - `FinancialAnalyzer(facts_df, standard, company_name, mapping=...)`
  - `get_pl_data()`, `get_bs_data()`, `get_cf_data()`（canonical wide）
  - `build_slide_payload()`（スライド生成に必要なデータと設定を返す）
- 特徴
  - canonical抽出はdimension無しを優先（セグメント分解の二重計上を抑制）。
  - portfolio抽出はdimension付きも許容。

### 3) `columuns_definition_config.py`
- 個社・会計基準の差異を集約する設定モジュール。
- 役割
  1) マッピング定義（canonical key → XBRL element候補）
  2) スライドのBS構造定義（Series/Stack/排他/優先表示）
- 主な関数
  - `resolve_mapping(standard, company_name)`
  - `resolve_layout(standard, company_name)`
- 会社別overrideをここに集約。

### 4) `slides_core.py`
- スライド生成ロジック（Matplotlibで画像生成 → PowerPoint貼り付け）。
- 重要機能
  - `build_trend_dataframe`, `build_snapshot_dataframe`
  - `plot_combo_bar_line_2axis`, `plot_balance_sheet`
- BS描画
  - `stack_preference` / `left_stack_preference` / `right_stack_preference` を尊重。
  - `exclusive_groups` による集計/内訳の排他制御。
  - `auto_balance_assets/liab_equity` により不足分を補正。

### 5) `run_analysis.ipynb`
- 実行I/F（ユーザーがここを実行）。
- 役割
  - XBRL解析結果をCSV保存
  - Analyzer経由でDUMPのPL/BS出力
  - スライド生成（PPT/PDF）

---

## データフロー
1. `input/XBRL/{company}/{company}_FY{year}.zip`
2. `xbrl_parser.py` → `output/{company}/{company}_FY{year}_parsed_xbrl.csv`
3. `financial_analyzer.py` が複数年CSVを結合しPL/BS/CF生成
4. `build_slide_payload()` で可視化用データとスライド設定を返す
5. `slides_core.py` が `output/` にPPT/PDFを生成

---

## 出力
- レポート
  - `output/{company}_report_YYYYmmdd_HHMMSS.pptx`
  - `output/{company}_report_YYYYmmdd_HHMMSS.pdf`

---

## 設計方針
- 個社・会計基準の違いは **configに集約**

---

## 会社別の既存オーバーライド
- `toyota` : Revenue/Pretax/NetIncomeのUSGAAP/IFRS混在期を補正。
- `honda`  : FY2012/FY2013のUSGAAP領域を補正。
- `mufg`   : 銀行形式のPL/BSを優先。

---
