# XbrlParser リポジトリ仕様書（現時点）

## 目的
- EDINETのXBRL（ZIP）を解析し、企業別のPL/BS/CFをCSV化し、PPT/PDFレポートを自動生成する。
- 企業固有の差異は「マッピング設定」に集約し、汎用ロジックを簡潔に保つ。
  - 既定はMatplotlibで描画。明示的に指定した場合のみPlotlyで描画可能（見た目は同一を目標だが、実際には差異が出る可能性あり）。

---

## 全体アーキテクチャ
1. XBRL解析 → facts DataFrame
2. PL/BS/CFの正規化（canonical化）と抽出
3. 可視化用データ（trend/snapshot）生成
4. スライド生成（PPT/PDF）

---

## 主要ファイル

### 1) `xbrl_parser.py`
- EDINET XBRL ZIPからインスタンスを抽出して解析。
- 出力はfacts形式のDataFrame（1行=1事実）。
- 主要列
  - `Tag`, `Element`, `Label`, `Value`
  - `ContextID`, `Consolidated`
  - `Standard`（IFRS/USGAAP/JGAAP）
  - `period_type`, `period_start`, `period_end`
  - `numeric_value`, `currency`, `dimensions`, `is_text_block`
- 期間の正規化、連結/単独の判定を実施。

### 2) `financial_analyzer.py`
- factsからcanonical PL/BS/CFを構築する中核。
- `ColumnDefinitionConfig`を参照し、個社差異に対応。
- 主要API
  - `FinancialAnalyzer(facts_df, standard, company_name, mapping=...)`
  - `get_pl_data()`, `get_bs_data()`, `get_cf_data()`
  - `build_slide_payload()`
- 方針
  - canonical抽出はdimension無しを優先（セグメント由来の二重計上を回避）。
  - portfolio抽出はdimension付きも許容（ガードレール付き）。

### 3) `columuns_definition_config.py`
- マッピングとレイアウト定義の集約モジュール。
- 役割
  1) canonical mapping（key → element候補）
  2) スライド構造定義（series/stack/ラベル）
- 主要関数
  - `resolve_mapping(standard, company_name)`
  - `resolve_layout(standard, company_name)`

### 4) `slides_core.py`
- 可視化とPPT生成。
- 主要関数
  - `build_trend_dataframe`, `build_snapshot_dataframe`
  - `plot_combo_bar_line_2axis`, `plot_balance_sheet`
  - `build_slide_deck(...)`（ページ選択・テキスト挿入を含むスライド生成）
  - 描画エンジン
    - `SlideConfig(engine="matplotlib")` が既定。
    - `SlideConfig(engine="plotly")` を明示したときのみPlotlyに切替。
    - Plotlyはkaleidoで画像を書き出し、PowerPointへ貼り込み。

### 5) `run_analysis.ipynb`
- 実行I/F（ユーザーがここを実行）。
- Notebookで設定する項目
  - どのページを出すか（PL/BS/CF/Portfolio）
  - 各ページのテキスト
- それ以外のページ生成ロジックは`slides_core.py`側に集約。

---

## データフロー
1. `input/XBRL/{company}/{company}_FY{year}.zip`
2. `xbrl_parser.py` → `output/{company}/{company}_FY{year}_parsed_xbrl.csv`
3. `financial_analyzer.py` が複数年CSVを結合しPL/BS/CF生成
4. `build_slide_payload()` が可視化用データとレイアウトを返す
5. `slides_core.py` がPPT/PDFを `output/` に生成

---

## 出力
- `DUMP_{company}_PL.csv`
- `DUMP_{company}_BS.csv`
- `output/{company}_report_YYYYmmdd_HHMMSS.pptx`
- `output/{company}_report_YYYYmmdd_HHMMSS.pdf`

---

## コンフィグ/オプションの要点
### 1) 描画エンジン
- 既定: Matplotlib
  - `SlideConfig(engine="matplotlib")`
- オプション: Plotly
  - `SlideConfig(engine="plotly")` のときだけ利用。
  - 画像化はkaleidoを使用（Plotlyの静的画像出力）。
  - データは同じだが、フォント・余白・凡例位置など見た目が一致しない場合がある。

### 2) テンプレート/出力
- `SlideConfig(template_path=..., output_dir=...)`
- 既定テンプレート: `template/template_16-9.pptx`（なければ`template.pptx`）

### 3) レイアウト/ページ構成
- `build_slide_deck(...)` でページ選択とテキスト差し込み。
- ページ単位で `SlidePageConfig` により色/フォント/レイアウト上書き可能。

### 4) マッピング/レイアウト
- `columuns_definition_config.py` で標準/会社別のマッピングとレイアウトを管理。
- `custom_mapping.json` があれば上書き可能（存在しない場合は警告のみ）。

--- 

## BSカラム表示規則（詳細）

### 1) スタックのソース
- 左（Assets）
  - `left_stack`（詳細）
  - `left_stack_summary`（要約）
  - `left_stack_for_bank`（銀行向け）
- 右（Liabilities & Equity）
  - `right_stack`（詳細）
  - `right_stack_summary`（要約）
  - `right_stack_for_bank`（銀行向け）
- サマリーの基本構成
  - Assets: `Current Assets`, `Non-Current Assets`
  - Liabilities & Equity: `Current Liabilities`, `Non-Current Liabilities`, `Total Equity`

### 2) スタック選択ルール
- `stack_preference` を左右の既定に使う。
- `left_stack_preference` / `right_stack_preference` が優先。
- `detail_bars=True` の場合は詳細スタックを優先。
- `is_bank=True` の場合は銀行向けスタックを優先。
- Total Assetsとの整合が`balance_tolerance`以内になるスタックを選ぶ。

### 3) 排他グループ（重複回避）
- `exclusive_groups`で「集計と内訳の同時表示」を禁止。
- 例：`Other Financial Assets`と`Other Financial Assets (Current/Non-Current)`が同時に表示されないようにする。

### 4) 自動バランス補正
- `auto_balance_assets=True` のとき不足分は`Other Assets`で補完。
- `auto_balance_liab_equity=True` のとき不足分は`Other Liab/Equity`で補完。

### 5) ラベル配置（重なりの厳密回避）
- `group_label_position="inside"`：グループラベルは棒の内側に配置。
- `avoid_label_overlap=True`：棒内グループラベルを優先し、セグメントラベルは無効化。
- `group_label_min_ratio`：小さすぎるグループはラベルを省略。
- `summary_label_position="inside"`：サマリーラベルも棒内に配置。
- これにより縦軸目盛りとの重なりを回避する。

### 6) 凡例
- 既定は右側（棒の外）に表示。
- `legend_inside=True`で棒内に移動可能。

---

## 会社別オーバーライド
- `toyota`：Revenue/Pretax/NetIncomeのIFRS/USGAAP混在期を補正。
- `honda`：USGAAP対象年の補正。
- `mufg`：銀行形式のPL/BSを優先。

---

## 新しい銘柄への挙動（想定）
- `Standard` はfactsから推定（IFRS/USGAAP/JGAAP）。標準マッピングでPL/BS/CFを抽出。
- 会社固有の差異がなければ、デフォルトのマッピング/レイアウトでレポートが生成される。
- BSの最新期は「Total Assetsがある期」を優先（存在しなければ最新の数値がある期）。
- Dimension付きデータは原則除外（連結/単独の軸だけを許容）。セグメント由来の重複計上は避ける方針。
- Portfolioはルールベース抽出（該当タグがなければ空の系列になり得る）。

## 新しい銘柄集計時に必要になり得る作業
1. `input/XBRL/{company}/` に対象年のZIPを配置（命名規則: `{company}_FY{year}.zip`）
2. 会社固有のタグ差異がある場合:
   - `columuns_definition_config.py` の `_COMPANY_OVERRIDES` に追加
   - 必要に応じて `custom_mapping.json` を用意
3. レイアウト差異（銀行形式やBSスタック等）が必要な場合:
   - `_COMPANY_LAYOUT_OVERRIDES` に追加（`is_bank`、`stack_preference` 等）
4. 抽出結果の確認:
   - `DUMP_{company}_PL.csv` / `DUMP_{company}_BS.csv`
   - BSの左右一致と主要科目の妥当性
5. 生成PDFの目視確認（PPT/PDFはPowerPoint COM依存）

---

## 注意点
- 連結/単独の区別はdimensions処理が必須。
- PDF生成はPowerPoint COM依存。
